name: Claude Code Review (Z AI)

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits for HEAD~1 comparison

      - name: Install GH CLI
        uses: dev-hanz-ops/install-gh-cli-action@v0.2.1

      - name: Prepare Environment
        run: |
          curl -fsSL https://bun.sh/install | bash
          mkdir -p $HOME/.claude-code-router
          cat << 'EOF' > $HOME/.claude-code-router/config.json
          {
            "LOG": true,
            "NON_INTERACTIVE_MODE": true,
            "API_TIMEOUT_MS": 3000000,
            "APIKEY": "sk-ant-zai-placeholder-key-for-router-auth",
            "HOST": "0.0.0.0",
            "Providers": [
              {
                "name": "zai",
                "api_base_url": "https://open.bigmodel.cn/api/paas/v4/chat/completions",
                "api_key": "${{ secrets.Z_AI_API_KEY }}",
                "models": ["GLM-4.7", "GLM-4.5-Air"],
                "transformer": {
                  "use": ["Anthropic"]
                }
              }
            ],
            "Router": {
              "default": "zai,GLM-4.7",
              "think": "zai,GLM-4.7"
            }
          }
          EOF
        shell: bash

      - name: Start Claude Code Router
        run: |
          nohup ~/.bun/bin/bunx @musistudio/claude-code-router@latest start &
          # Wait for router to be ready
          sleep 5
          curl -s http://localhost:3456/health || exit 1
        shell: bash

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
          ANTHROPIC_API_KEY: "sk-ant-zai-placeholder-key-for-router-auth"
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            COMMIT SHA (that triggered this workflow): ${{ github.event.after }}

            # You are reviewing a PR for LexiconFlow, a Swift 6 iOS app using SwiftUI and SwiftData.

            ## Scope: REVIEW ONLY THE LAST COMMIT

            CRITICAL: You MUST review ONLY the changes in the last commit that triggered this workflow.

            DO NOT review the entire PR - ONLY review the specific commit: ${{ github.event.after }}

            ### Step 0: Verify Commit Scope (MANDATORY FIRST STEP)

            Before starting the review, you MUST:

            1. Identify the commit being reviewed:
            ```bash
            COMMIT_SHA="${{ github.event.after }}"
            echo "Reviewing commit: $COMMIT_SHA"
            git log -1 --oneline $COMMIT_SHA
            ```

            2. Get ONLY the changes in this commit:
            ```bash
            git show --name-status $COMMIT_SHA
            git show $COMMIT_SHA
            ```

            3. Verify you're reviewing the right scope:
            ```bash
            git diff-tree --no-commit-id --name-only -r $COMMIT_SHA
            ```

            DO NOT use:
            - git diff HEAD~1 HEAD (may include multiple commits if force-pushed)
            - gh pr diff (shows entire PR diff, not just this commit)
            - git log without specifying commit SHA (shows full history)

            ONLY review files that appear in: git show $COMMIT_SHA

            ## Review Structure Requirements

            1. ALL code-specific comments MUST be inline comments bound to file:line using gh API
            2. Summary MUST be ultra-concise - 1-3 sentences maximum using gh pr review
            3. Summary format: "Status + Please see inline comments" - NOTHING MORE
            4. Inline comments = all details: File-specific issues, code examples, recommendations
            5. ACTIONABLE ONLY: Post comments ONLY for issues requiring action (no positive fluff)
            6. NO DUPLICATION: Never repeat inline comment details in summary
            7. COMMIT-SPECIFIC: Comment on lines changed in commit ${{ github.event.after }} ONLY

            ## Review Checklist (CLAUDE.md conventions)

            Focus ONLY on changes in commit ${{ github.event.after }}:

            - Swift 6 strict concurrency compliance (@MainActor, actor isolation, Sendable)
            - No force unwraps (!) - use optional binding (if let, guard let, ??)
            - No fatalError in app initialization - use graceful degradation pattern
            - SwiftData model mutations on @MainActor only (not across actor boundaries)
            - DTO pattern for cross-actor data transfer (return structs, not models)
            - No string enums in #Predicate (use string literals, avoid enum.rawValue)
            - AppSettings class instead of direct @AppStorage (centralized state)
            - Error handling with user alerts + Analytics.trackError()
            - Test coverage >80% for new code (Swift Testing framework, not XCTest)
            - Naming: Use Flashcard not Card (avoid collision with FSRS library)
            - Timezone-aware date math using DateMath.elapsedDays()
            - External storage for images (@Attribute(.externalStorage))

            ## How to Post Review

            ### Step 1: Get PR and Commit Context
            ```bash
            PR_NUMBER=${{ github.event.pull_request.number }}
            COMMIT_SHA=${{ github.event.after }}

            echo "Reviewing PR #$PR_NUMBER, Commit: $COMMIT_SHA"
            git show --name-status $COMMIT_SHA
            ```

            ### Step 2: Review Changes in This Commit Only
            ```bash
            git show $COMMIT_SHA > /tmp/commit-diff.txt

            FILES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_SHA)
            echo "Files to review: $FILES"
            ```

            ### Step 3: Read Changed Files
            ```bash
            for file in $FILES; do
              echo "Reviewing: $file"
              # Use Read tool to examine the file
              # Cross-reference with git show output to see what changed
            done
            ```

            ### Step 4: Post Inline Comments (for each code-specific issue)
            ```bash
            # Only for ACTIONABLE issues requiring code changes
            # MUST reference lines that were CHANGED in commit $COMMIT_SHA
            gh api --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/pulls/$PR_NUMBER/comments \
              -f body="Issue description" \
              -f commit_id="$COMMIT_SHA" \
              -f path="relative/path/to/file.swift" \
              -f line=15 \
              -f side=RIGHT
            ```

            CRITICAL: Line numbers MUST correspond to lines changed in commit ${{ github.event.after }}

            DO NOT POST inline comments for:
            - Positive feedback ("Good job", "Great implementation")
            - Non-actionable observations ("This looks correct")
            - Praise or encouragement
            - Lines NOT changed in this commit

            ### Step 5: Post Ultra-Concise Summary
            ```bash
            # If critical issues found:
            gh pr review $PR_NUMBER --commit $COMMIT_SHA --request-changes \
              --body "3 critical issues in this commit. Please see inline comments."

            # If only suggestions:
            gh pr review $PR_NUMBER --commit $COMMIT_SHA --comment \
              --body "5 suggestions posted for this commit. No blocking issues."

            # If no issues:
            gh pr review $PR_NUMBER --commit $COMMIT_SHA --approve \
              --body "This commit approved."
            ```

            ## Summary Templates

            Request Changes:
            - "3 critical issues in this commit. Please see inline comments."

            Comment (non-blocking):
            - "5 suggestions posted for this commit. No blocking issues."

            Approve:
            - "This commit approved."

            ## Validation Checklist

            Before posting, verify:
            - [ ] Reviewed ONLY commit ${{ github.event.after }} (not entire PR)
            - [ ] Used git show ${{ github.event.after }} to see changes
            - [ ] All file:line references are from lines changed in this commit
            - [ ] Each code issue posted as inline comment to specific line
            - [ ] Filtered out all non-actionable positive feedback
            - [ ] Summary is 1-3 sentences maximum
            - [ ] Summary contains ONLY: status emoji + issue count + "see inline comments"
            - [ ] No duplicate information between inline and summary
            - [ ] No comments on lines not changed in this commit

            Now proceed with the review following these rules exactly. Start by verifying commit scope.
          claude_args: |
            --model opus --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr review:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api:*),Bash(gh repo view:*),Bash(git log:*),Bash(git diff:*),Bash(git show:*),Bash(git show:*),Bash(git diff-tree:*),Write(/tmp/*),Bash(cat:*),Bash(echo:*),Bash(jq:*),Bash(sed:*),Bash(rm:*)"
