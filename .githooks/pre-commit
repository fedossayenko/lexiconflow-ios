#!/bin/bash
#
# Pre-commit hook to enforce code quality standards
#
# This hook prevents commits that:
# - Use force unwrap (!) in production code
# - Use fatalError in production code
# - Fail SwiftLint checks
#
# Install: chmod +x .git/hooks/pre-commit
# Skip: git commit --no-verify

set -e

echo "üîç Running pre-commit quality checks..."

# Get list of staged files (excluding tests)
STAGED_FILES=$(git diff --cached --name-only | grep -v Test | grep "\.swift$" || true)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No Swift files to check (or only test files)"
    exit 0
fi

echo "üìù Checking files:"
echo "$STAGED_FILES"
echo ""

# Track if any check failed
FAILED=0

# 1. Check for force unwrap in production code
echo "üîé Checking for force unwrap (!)..."
FORCE_UNWRAP_FILES=""
for file in $STAGED_FILES; do
    # Look for force unwrap patterns (excluding comments and strings)
    if git diff --cached "$file" | grep -E '^\+.*!' | grep -v '//.*!' | grep -v '//' | grep -E '\!\s*[\)\]\w]' > /dev/null 2>&1; then
        FORCE_UNWRAP_FILES="$FORCE_UNWRAP_FILES $file"
    fi
done

if [ -n "$FORCE_UNWRAP_FILES" ]; then
    echo "‚ùå ERROR: Force unwrap (!) found in production code:"
    echo "$FORCE_UNWRAP_FILES"
    echo ""
    echo "Please use optional binding or nil coalescing instead:"
    echo "  ‚ùå let value = optional!"
    echo "  ‚úÖ let value = optional ?? defaultValue"
    echo "  ‚úÖ if let value = optional { ... }"
    echo ""
    echo "Skip checks with: git commit --no-verify"
    FAILED=1
else
    echo "‚úÖ No force unwrap found"
fi

# 2. Check for fatalError in production code
echo ""
echo "üîé Checking for fatalError calls..."
FATAL_ERROR_FILES=""
for file in $STAGED_FILES; do
    # Look for fatalError calls
    if git diff --cached "$file" | grep -E '^\+.*fatalError' > /dev/null 2>&1; then
        FATAL_ERROR_FILES="$FATAL_ERROR_FILES $file"
    fi
done

if [ -n "$FATAL_ERROR_FILES" ]; then
    echo "‚ö†Ô∏è  WARNING: fatalError found in production code:"
    echo "$FATAL_ERROR_FILES"
    echo ""
    echo "Please use graceful error handling instead:"
    echo "  ‚ùå fatalError(\"Failed to connect\")"
    echo "  ‚úÖ return Result.failure(Error.connectionFailed)"
    echo ""
    echo "Override checks with: git commit --no-verify"
    # Warning only, don't fail
else
    echo "‚úÖ No fatalError calls found"
fi

# 3. Run SwiftLint if available
echo ""
echo "üîé Running SwiftLint..."
if command -v swiftlint &> /dev/null; then
    # Run swiftlint only on staged files
    SWIFTLINT_OUTPUT=$(echo "$STAGED_FILES" | xargs swiftlint --quiet 2>&1 || true)

    # Filter to only errors (not warnings)
    SWIFTLINT_ERRORS=$(echo "$SWIFTLINT_OUTPUT" | grep "::error" || true)

    if [ -n "$SWIFTLINT_ERRORS" ]; then
        echo "‚ùå SwiftLint found errors:"
        echo "$SWIFTLINT_ERRORS"
        echo ""
        echo "Run 'swiftlint --fix' to auto-fix some issues"
        echo "Skip checks with: git commit --no-verify"
        FAILED=1
    elif [ -n "$SWIFTLINT_OUTPUT" ]; then
        # Only warnings - show but don't fail
        echo "‚ö†Ô∏è  SwiftLint found warnings (not blocking):"
        echo "$SWIFTLINT_OUTPUT" | grep "::warning" | head -5 || true
        echo "‚úÖ SwiftLint passed (warnings only)"
    else
        echo "‚úÖ SwiftLint passed"
    fi
else
    echo "‚ö†Ô∏è  SwiftLint not installed. Install with: brew install swiftlint"
fi

# 4. Run SwiftFormat if available (checks entire project)
echo ""
echo "üîé Running SwiftFormat on entire project..."
if command -v swiftformat &> /dev/null; then
    # Run swiftformat in lint mode on entire project
    if ! swiftformat --lint . 2>&1; then
        echo ""
        echo "‚ùå SwiftFormat found formatting issues"
        echo "   Run 'swiftformat .' to auto-fix formatting"
        echo "   Skip checks with: git commit --no-verify"
        FAILED=1
    else
        echo "‚úÖ SwiftFormat passed"
    fi
else
    echo "‚ö†Ô∏è  SwiftFormat not installed. Install with: brew install swiftformat"
fi

# Final result
echo ""
if [ $FAILED -eq 1 ]; then
    echo "‚ùå Pre-commit checks failed"
    echo "   Fix issues above or override with: git commit --no-verify"
    exit 1
else
    echo "‚úÖ All pre-commit checks passed"
    exit 0
fi
